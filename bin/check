#!/bin/sh

exec 3>&1 # make stdout available as fd 3 for the result
exec 1>&2 # redirect all output to stderr for logging
. $(dirname $0)/functions.sh


input=$(cat)


stack_name="$(echo "${input}" | jq -r '.source.name // empty')"
region="$(echo "${input}" | jq -r '.source.region // empty')"
arn="$(echo "${input}" | jq -r '.version.arn? // empty')"
time="$(echo "${input}" | jq -r '.version.time? // empty')"

if [ -z "${region}" ]; then
    echo "Must specify 'region' in source"
    exit 1
fi

if [ -z "${stack_name}" ]; then
    echo "Must specify 'stack_name' in source"
    exit 1
fi
output="$(load_stack "${region}" "${stack_name}")"
status="$?"

if [ "${status}" -ne 0 ]; then
    echo "${output}"
    exit "${status}"
fi

new_arn="$(echo "${output}" | jq -r '.StackId')"
new_time="$(echo "${output}" | jq -r '.LastUpdatedTime // .CreationTime')"


if [ "${new_arn}" != "${arn}" ] || [  "${new_time}" != "${time}" ]; then
    jq -n -c -r --arg new_arn "${new_arn}" --arg new_time "${new_time}" '[{ "arn": $new_arn, "time": $new_time }]' >&3
else
    jq -n -c -r '[]' >&3
fi
